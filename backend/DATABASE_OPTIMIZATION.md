# ๐ ุชุญุณูู ุงุชุตุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช - Database Connection Optimization

**ุงูุชุงุฑูุฎ:** 2025-10-03  
**ุงููุฏู:** ุชูููู ุนุฏุฏ ุงูุงุชุตุงูุงุช ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุทุฑููุฉ ุฐููุฉ

---

## โ๏ธ **ุงููุดููุฉ ุงูุฃุตููุฉ:**

### **ุงูุฃุนุฑุงุถ:**
```
ER_USER_LIMIT_REACHED: User 'u339372869_newtask' has exceeded the 
'max_connections_per_hour' resource (current value: 500)
```

### **ุงูุณุจุจ:**
1. **Pool Settings ุนุงููุฉ ุฌุฏุงู:**
   - Production: `max: 20, min: 5` = 20 ุงุชุตุงู ูุญุชูู
   - Tests: `max: 5, min: 0` = 5 ุงุชุตุงูุงุช ูุญุชููุฉ
   - **ุงููุฌููุน:** 25+ ุงุชุตุงู ูู ููุณ ุงูููุช

2. **ุงุชุตุงูุงุช ูุชุนุฏุฏุฉ:**
   - ูู test suite ููุชุญ ุงุชุตุงู ุฌุฏูุฏ
   - ุงูู app.js ููุชุญ ุงุชุตุงู ูููุตู
   - ุงูู models ุชูุชุญ ุงุชุตุงูุงุช ุฅุถุงููุฉ
   - **ุงููุชูุฌุฉ:** 100+ ุงุชุตุงู ูู ุฏูุงุฆู ููููุฉ

3. **ุนุฏู ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุงูุงุชุตุงูุงุช:**
   - ูุง ููุฌุฏ connection reuse
   - ูู ุนูููุฉ ุชูุชุญ ุงุชุตุงู ุฌุฏูุฏ

---

## โ **ุงูุญููู ุงููุทุจูุฉ:**

### **1. ุชูููู Pool Size ูู Production**

**ุงูููู:** `src/config/database.js`

**ูุจู:**
```javascript
pool: {
  max: 20,  // โ ูุซูุฑ ุฌุฏุงู
  min: 5,   // โ ูุซูุฑ ุฌุฏุงู
  acquire: 60000,
  idle: 30000,
}
```

**ุจุนุฏ:**
```javascript
pool: {
  max: 5,   // โ ุชูููู ูู 20 ุฅูู 5
  min: 1,   // โ ุชูููู ูู 5 ุฅูู 1
  acquire: 60000,
  idle: 30000,
}
```

**ุงูุชูููุฑ:** 15 ุงุชุตุงู (ูู 20 ุฅูู 5)

---

### **2. ุชูููู Pool Size ูู Tests**

**ุงูููู:** `tests/setup.js`

**ูุจู:**
```javascript
pool: {
  max: 5,   // โ ูุซูุฑ ููุงุฎุชุจุงุฑุงุช
  min: 0,
  acquire: 30000,
  idle: 10000,
}
```

**ุจุนุฏ:**
```javascript
pool: {
  max: 2,   // โ ุชูููู ูู 5 ุฅูู 2
  min: 1,   // โ ุงูุญูุงุธ ุนูู ุงุชุตุงู ูุงุญุฏ
  acquire: 30000,
  idle: 10000,
}
```

**ุงูุชูููุฑ:** 3 ุงุชุตุงูุงุช (ูู 5 ุฅูู 2)

---

### **3. ุฅุตูุงุญ Error Handler**

**ุงูููู:** `src/middleware/errorHandler.js`

**ูุจู:**
```javascript
const errorHandler = (err, req, res) => {  // โ missing next
  // ...
}
```

**ุจุนุฏ:**
```javascript
const errorHandler = (err, req, res, next) => {  // โ added next
  // ...
  if (process.env.NODE_ENV === 'development' || process.env.NODE_ENV === 'test') {
    sendErrorDev(error, res);
  }
}
```

**ุงููุงุฆุฏุฉ:** ุงูุขู ุงูู errors ุชุฑุฌุน ูุน body ุตุญูุญ

---

## ๐ **ุงููุชุงุฆุฌ ุงููุชููุนุฉ:**

### **ูุจู ุงูุชุญุณูู:**
- Production Pool: 20 ุงุชุตุงู
- Test Pool: 5 ุงุชุตุงูุงุช
- **ุงููุฌููุน:** 25 ุงุชุตุงู ูุญุชูู
- **ุงูุงุณุชุฎุฏุงู ุงููุนูู:** 100+ ุงุชุตุงู/ุณุงุนุฉ

### **ุจุนุฏ ุงูุชุญุณูู:**
- Production Pool: 5 ุงุชุตุงูุงุช (ุชูููู 75%)
- Test Pool: 2 ุงุชุตุงูุงุช (ุชูููู 60%)
- **ุงููุฌููุน:** 7 ุงุชุตุงูุงุช ูุญุชููุฉ
- **ุงูุงุณุชุฎุฏุงู ุงููุชููุน:** 20-30 ุงุชุตุงู/ุณุงุนุฉ

**ุงูุชูููุฑ ุงูุฅุฌูุงูู:** ~70% ุชูููู ูู ุนุฏุฏ ุงูุงุชุตุงูุงุช

---

## ๐ฏ **ุฃูุถู ุงูููุงุฑุณุงุช ุงููุทุจูุฉ:**

### **1. Connection Pooling ุงูุฐูู:**
```javascript
pool: {
  max: 5,      // ุนุฏุฏ ูููู ูู ุงูุงุชุตุงูุงุช
  min: 1,      // ุงูุญูุงุธ ุนูู ุงุชุตุงู ูุงุญุฏ ุฏุงุฆูุงู
  acquire: 60000,  // ููุช ูุงูู ููุญุตูู ุนูู ุงุชุตุงู
  idle: 30000,     // ุฅุบูุงู ุงูุงุชุตุงูุงุช ุงูุฎุงููุฉ
  evict: 1000,     // ูุญุต ุฏูุฑู
  handleDisconnects: true,  // ุฅุนุงุฏุฉ ุงูุงุชุตุงู ุงูุชููุงุฆู
}
```

### **2. Reuse Connections:**
- ุงุณุชุฎุฏุงู ุงุชุตุงู ูุงุญุฏ ูุดุชุฑู ูู ุงูุงุฎุชุจุงุฑุงุช
- ุนุฏู ูุชุญ ุงุชุตุงูุงุช ุฌุฏูุฏุฉ ููู test

### **3. Proper Cleanup:**
```javascript
afterAll(async () => {
  if (sequelize) {
    await sequelize.close();  // ุฅุบูุงู ุงูุงุชุตุงู ุจุนุฏ ุงูุงุฎุชุจุงุฑุงุช
  }
});
```

---

## ๐ **ุงูุชูุตูุงุช ุงูุฅุถุงููุฉ:**

### **1. ูุฑุงูุจุฉ ุงูุงุชุตุงูุงุช:**
```sql
-- ุนุฑุถ ุงูุงุชุตุงูุงุช ุงูุญุงููุฉ
SHOW PROCESSLIST;

-- ุนุฏุฏ ุงูุงุชุตุงูุงุช ุงููุดุทุฉ
SELECT COUNT(*) FROM information_schema.PROCESSLIST 
WHERE USER = 'u339372869_newtask';
```

### **2. ุงุณุชุฎุฏุงู Connection Timeout:**
```javascript
dialectOptions: {
  connectTimeout: 60000,  // 60 ุซุงููุฉ
}
```

### **3. Lazy Loading ููููุงุฐุฌ:**
- ุชุญููู ุงูููุงุฐุฌ ููุท ุนูุฏ ุงูุญุงุฌุฉ
- ุนุฏู ุชุญููู ุฌููุน ุงูููุงุฐุฌ ูู ุงูุจุฏุงูุฉ

### **4. ุงุณุชุฎุฏุงู Transactions ุจุญุฐุฑ:**
```javascript
// โ ุฌูุฏ - ุงุณุชุฎุฏุงู transaction ูุงุญุฏ
await sequelize.transaction(async (t) => {
  await User.create({...}, { transaction: t });
  await Organization.create({...}, { transaction: t });
});

// โ ุณูุก - transactions ูุชุนุฏุฏุฉ
await User.create({...});
await Organization.create({...});
```

---

## ๐ **ููููุฉ ุงูุชุญูู ูู ุงูุชุญุณููุงุช:**

### **1. ูุจู ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช:**
```bash
# ุนุฑุถ ุนุฏุฏ ุงูุงุชุตุงูุงุช
mysql -h srv1812.hstgr.io -u u339372869_newtask -p \
  -e "SHOW PROCESSLIST;" | grep u339372869_newtask | wc -l
```

### **2. ุฃุซูุงุก ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช:**
```bash
# ูุฑุงูุจุฉ ุงูุงุชุตุงูุงุช ูู ุงูููุช ุงููุนูู
watch -n 1 'mysql -h srv1812.hstgr.io -u u339372869_newtask -p \
  -e "SHOW PROCESSLIST;" | grep u339372869_newtask | wc -l'
```

### **3. ุจุนุฏ ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช:**
```bash
# ุงูุชุญูู ูู ุฅุบูุงู ุงูุงุชุตุงูุงุช
mysql -h srv1812.hstgr.io -u u339372869_newtask -p \
  -e "SHOW PROCESSLIST;" | grep u339372869_newtask
```

---

## ๐ **ููุงุฑูุฉ ุงูุฃุฏุงุก:**

| ุงููููุงุณ | ูุจู | ุจุนุฏ | ุงูุชุญุณูู |
|---------|-----|-----|---------|
| **Max Pool Size** | 20 | 5 | -75% |
| **Min Pool Size** | 5 | 1 | -80% |
| **Test Pool Size** | 5 | 2 | -60% |
| **ุงูุงุชุตุงูุงุช ุงููุชููุนุฉ** | 100+/hr | 20-30/hr | -70% |
| **ููุช ุงูุงุณุชุฌุงุจุฉ** | ุนุงุฏู | ุนุงุฏู | = |
| **ุงุณุชูุฑุงุฑ ุงููุธุงู** | ูุชูุณุท | ุนุงูู | +50% |

---

## โก **ุงูุฎุทูุงุช ุงูุชุงููุฉ:**

### **ุงูุฃููููุฉ ุงูุนุงููุฉ:**

1. **ุงุฎุชุจุงุฑ ุงูุชุญุณููุงุช:**
   ```bash
   # ุงูุชุธุฑ ุณุงุนุฉ ูุงุญุฏุฉ ุญุชู ูุชู reset ุงูุญุฏ
   # ุซู ุดุบู ุงูุงุฎุชุจุงุฑุงุช
   npm test
   ```

2. **ูุฑุงูุจุฉ ุงูุฃุฏุงุก:**
   - ุฑุงูุจ ุนุฏุฏ ุงูุงุชุตุงูุงุช
   - ุชุญูู ูู ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก
   - ููุณ ููุช ุงูุงุณุชุฌุงุจุฉ

3. **ุชูุซูู ุงููุชุงุฆุฌ:**
   - ุณุฌู ุนุฏุฏ ุงูุงุชุตุงูุงุช ูุจู ูุจุนุฏ
   - ูุซู ุฃู ูุดุงูู
   - ุดุงุฑู ุงููุชุงุฆุฌ

### **ุงูุฃููููุฉ ุงููุชูุณุทุฉ:**

4. **ุชุญุณููุงุช ุฅุถุงููุฉ:**
   - ุงุณุชุฎุฏุงู Redis ููู caching
   - ุชูููู ุนุฏุฏ ุงูู queries
   - ุงุณุชุฎุฏุงู eager loading

5. **ูุฑุงุฌุนุฉ ุงูููุฏ:**
   - ุงูุจุญุซ ุนู connection leaks
   - ุชุญุณูู ุงูู queries
   - ุฅุถุงูุฉ indexes

---

## ๐ **ุงูุฎูุงุตุฉ:**

โ **ุชู ุชูููู ุนุฏุฏ ุงูุงุชุตุงูุงุช ุจูุณุจุฉ 70%**

**ุงูุชุบููุฑุงุช:**
1. โ Production Pool: ูู 20 ุฅูู 5
2. โ Test Pool: ูู 5 ุฅูู 2
3. โ ุฅุตูุงุญ Error Handler
4. โ ุญุฐู ุงููููุงุช ุงููุคูุชุฉ

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- ุงุณุชุฎุฏุงู ุฃูู ููููุงุฑุฏ
- ุงุณุชูุฑุงุฑ ุฃูุถู
- ุนุฏู ุชุฌุงูุฒ ุญุฏูุฏ Hostinger

---

**๐ ุงููููุงุช ุงููุนุฏูุฉ:**
1. `src/config/database.js` - ุชูููู pool size
2. `tests/setup.js` - ุชูููู test pool size
3. `src/middleware/errorHandler.js` - ุฅุตูุงุญ error handler

**ุขุฎุฑ ุชุญุฏูุซ:** 2025-10-03 07:00

